### å˜åŒ–ä¾¦æµ‹ ###
æ¸²æŸ“ï¼šä»çŠ¶æ€ç”ŸDOMï¼Œå†è¾“å‡ºåˆ°ç”¨æˆ·ç•Œé¢æ˜¾ç¤ºçš„ä¸€æ•´å¥—æµç¨‹
vueæœ€ç‹¬ç‰¹çš„ç‰¹æ€§ä¹‹ä¸€å°±æ˜¯å“åº”å¼ç³»ç»Ÿï¼Œé€šè¿‡ä¾¦æµ‹æ•°æ®æ¨¡å‹å¯¹è±¡å˜åŒ–ï¼Œé€šçŸ¥è§†å›¾è¿›è¡Œæ›´æ–°ï¼Œä½¿å¾—çŠ¶æ€ç®¡ç†éå¸¸ç®€å•ã€ç›´æ¥ã€‚

vue.jsçš„æ¸²æŸ“è¿‡ç¨‹æ˜¯å£°æ˜å¼çš„ï¼Œé€šè¿‡æ¨¡ç‰ˆæ¥æè¿°çŠ¶æ€ä¸DOMä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚

## ä¸ºä»€ä¹ˆè¦å¼•å…¥è™šæ‹ŸDOMï¼Ÿ##
vue.jsçš„å˜åŒ–ä¾¦æµ‹å±äºæ¨ï¼Œè¿›è¡Œæ›´ç»†ç²’åº¦æ›´æ–°ã€‚å‡å¦‚ä¸€ä¸ªçŠ¶æ€ç»‘å®šå¾ˆå¤šä¾èµ–ï¼Œæ¯ä¸ªä¾èµ–è¡¨ç¤ºä¸€ä¸ªå…·ä½“çš„DOMèŠ‚ç‚¹ï¼Œé‚£ä¹ˆå½“è¿™ä¸ªçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šå‘è¿™ä¸ªçŠ¶æ€çš„æ‰€æœ‰ä¾èµ–å‘é€é€šçŸ¥ï¼Œè®©å®ƒä»¬è¿›è¡Œæ›´æ–°DOMã€‚å½“ç„¶ï¼Œå› ä¸ºç²’åº¦æ›´ç»†ï¼Œæ¯ä¸ªçŠ¶æ€ç»‘å®šçš„ä¾èµ–è¶Šå¤šï¼Œä¾èµ–è¿½è¸ªåœ¨å†…å­˜ä¸Šçš„å¼€é”€ä¹Ÿå°±ä¼šè¶Šå¤§ã€‚å› æ­¤åœ¨2.0ä¸­å¼•å…¥è™šæ‹ŸDOMï¼Œå°†ç²’åº¦è°ƒæ•´ä¸ºä¸­ç­‰ç²’åº¦ï¼Œå³ä¸€ä¸ªçŠ¶æ€æ‰€ç»‘å®šçš„ä¾èµ–ä¸å†æ˜¯å…·ä½“çš„DOMèŠ‚ç‚¹ï¼Œè€Œæ˜¯ç»„ä»¶ï¼Œè¿™æ ·çŠ¶æ€å˜åŒ–åï¼Œä¼šé€šçŸ¥åˆ°ç»„ä»¶ï¼Œç»„ä»¶å†…éƒ¨å†ä½¿ç”¨è™šæ‹ŸDOMè¿›è¡Œæ¯”å¯¹ï¼Œå¤§å¤§é™ä½ä¾èµ–æ•°é‡ï¼Œä»è€Œé™ä½ä¾èµ–è¿½è¸ªæ‰€æ¶ˆè€—çš„å†…å­˜ã€‚

## å¦‚ä½•è¿½è¸ªå˜åŒ– ##
JSä¸­ä¾¦æµ‹å˜åŒ–å¯ä»¥ä½¿ç”¨Object.definePropertyå’ŒES6çš„Proxyï¼Œ2.0ä½¿ç”¨å‰è€…ï¼Œ3.0ä½¿ç”¨Proxy
```
function defineReactive (data, key, val) {
    Object.defineProperty (data, key, {
        enumerable: true,
        configurable: true,
        get: function () {
            return val;
        },
        set: function (newVal) {
            if (val === newVal) {
                return;
            }
            val = newVal;
        }
    })
}
```
é€šè¿‡ difineReative å¯¹Object.definePropertyè¿›è¡Œå°è£…ï¼Œå®šä¹‰ä¸€ä¸ªå“åº”å¼æ•°æ®ï¼Œæ¯å½“ä»dataçš„keyä¸­è¯»å–æ•°æ®ï¼Œgetå‡½æ•°è¢«è§¦å‘ï¼Œå¾€dataçš„keyä¸­è®¾ç½®æ•°æ®ï¼Œsetå‡½æ•°è¢«è§¦å‘ã€‚

## å¦‚ä½•æ”¶é›†ä¾èµ– ##
æˆ‘ä»¬ä¹‹æ‰€ä»¥è¦è§‚å¯Ÿæ•°æ®ï¼Œå…¶ç›®çš„æ˜¯å½“æ•°æ®çš„å±æ€§å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¯ä»¥é€šçŸ¥é‚£äº›æ›¾ç»ä½¿ç”¨äº†è¯¥æ•°æ®çš„åœ°æ–¹
ä¾‹å¦‚æˆ‘ä»¬åœ¨æ¨¡ç‰ˆä¸­å†™å…¥ï¼š
```
<template>
    <h1>{{name}}</h1>
</template>
```
åœ¨vue2.0ä¸­ï¼Œæ¨¡ç‰ˆä½¿ç”¨æ•°æ®ç­‰åŒäºç»„ä»¶ä½¿ç”¨æ•°æ®ï¼Œæ‰€ä»¥å½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šå°†é€šçŸ¥å‘é€åˆ°ç»„ä»¶ï¼Œç„¶åç»„ä»¶å†…éƒ¨å†é€šè¿‡è™šæ‹ŸDOMé‡æ–°æ¸²æŸ“ã€‚
å› æ­¤æˆ‘ä»¬éœ€è¦æŠŠæ‰€æœ‰ç”¨åˆ°æ•°æ®nameçš„åœ°æ–¹æ”¶é›†èµ·æ¥ï¼Œç„¶åç­‰å±æ€§å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒæŠŠä¹‹å‰æ”¶é›†çš„ä¾èµ–å¾ªç¯è§¦å‘ä¸€éå°±å¥½äº†ã€‚
æ€»ç»“ï¼šåœ¨getterä¸­æ”¶é›†ä¾èµ–ï¼Œåœ¨setterä¸­è§¦å‘ä¾èµ–
```
function defineReactive (data, key, val) {
    let dep = []; // æ–°å¢ï¼Œå­˜å‚¨å½“å‰keyçš„ä¾èµ–
    Object.defineProperty (data, key, {
        enumerable: true,
        configurable: true,
        get: function () {
            dep.push(window.target) // add
            return val;
        },
        set: function (newVal) {
            if (val === newVal) {
                return;
            }
            // add
            for (let i = 0; i < dep.length; i++) {
                dep[i](newVal, val)
            }
            val = newVal;
        }
    })
}
```
å‡è®¾ä¾èµ–æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¿å­˜åœ¨window.targetä¸Šï¼Œæˆ‘ä»¬é€šè¿‡æ–°å¢æ•°ç»„depï¼Œå­˜å‚¨è¢«æ”¶é›†çš„ä¾èµ–ï¼Œç„¶ååœ¨setè¢«è§¦å‘æ—¶ï¼Œå¾ªç¯depä»¥è§¦å‘æ”¶é›†åˆ°çš„ä¾èµ–ã€‚ä½†ğŸ‘†çš„å†™æ³•æœ‰ç‚¹è€¦åˆï¼Œæˆ‘ä»¬å°†ä¾èµ–æ”¶é›†çš„ä»£ç å°è£…æˆä¸€ä¸ªDepç±»ï¼Œä¸“é—¨å¸®åŠ©æˆ‘ä»¬ç®¡ç†ä¾èµ–ï¼Œé€šè¿‡è¿™ä¸ªç±»ï¼Œå¯ä»¥æ”¶é›†ä¾èµ–ï¼Œåˆ é™¤ä¾èµ–æˆ–è€…å‘ä¾èµ–å‘é€é€šçŸ¥ã€‚ğŸ‘‡ğŸ‘‡æˆ‘ä»¬å°†ä¾èµ–æ”¶é›†åˆ°Depä¸­
```
export default class Dep {
    constructor () {
        this.subs = []
    }

    addSub (sub) {
        this.subs.push(sub)
    }

    removeSub (sub) {
        remove (this.subs, sub)
    }

    depend () {
        if (window.target) {
            this.addSub(window.target)
        }
    }

    notify () {
        const subs = this.subs.slice()
        for (let i = 0, l = subs.length; i < l; i++) {
            subs[i].update()
        }
    }
}

function remove (arr, item) {
    if (arr.length) {
        const index = arr.indexOf(item)
        if (index > -1) {
            return arr.splice(index, 1)
        }
    }
}

function defineReactive (data, key, val) {
    let dep = new Dep(); // update
    Object.defineProperty (data, key, {
        enumerable: true,
        configurable: true,
        get: function () {
            dep.depend() // update
            return val;
        },
        set: function (newVal) {
            if (val === newVal) {
                return;
            }
            val = newVal;
            dep.notify() // update
        }
    })
}
```
## ä¾èµ–æ˜¯è° ##

å½“å±æ€§å‘ç”Ÿå˜åŒ–åï¼Œåº”è¯¥é€šçŸ¥è°ï¼Œä½¿ç”¨æ•°æ®çš„åœ°æ–¹æœ‰å¾ˆå¤šï¼Œè€Œä¸”ç±»å‹è¿˜ä¸ä¸€æ ·ï¼Œæ—¢æœ‰å¯èƒ½æ˜¯æ¨¡ç‰ˆï¼Œä¹Ÿå¯èƒ½æ˜¯ç”¨æˆ·å†™çš„ä¸€ä¸ªwatchï¼Œéœ€è¦æŠ½è±¡å‡ºä¸€ä¸ªèƒ½é›†ä¸­å¤„ç†è¿™äº›æƒ…å†µçš„ç±»ï¼Œç„¶åï¼Œæˆ‘ä»¬åœ¨ä¾èµ–æ”¶é›†é˜¶æ®µåªæ”¶é›†è¿™ä¸ªå°è£…å¥½çš„ç±»çš„å®ä¾‹ï¼Œé€šçŸ¥ä¹Ÿåªé€šçŸ¥å®ƒä¸€ä¸ªï¼Œç„¶åå®ƒå†è´Ÿè´£é€šçŸ¥å…¶ä»–ã€‚

å®šä¹‰ä¸€ä¸ªWatcherä½œä¸ºä¸­ä»‹ä¼ é€’æ¶ˆæ¯

é¦–å…ˆçœ‹ä¸€ä¸‹watchçš„å¸¸ç”¨æ–¹å¼ï¼š
```
vm.$watch('a.b.c', function (newVal, oldVal) {
    // todo
})
```
è¿™æ®µä»£ç è¡¨ç¤ºå½“data.a.b.cå±æ€§å˜åŒ–æ—¶ï¼Œæ‰§è¡Œç¬¬äºŒä¸ªå‚æ•°ä¸­çš„å‡½æ•°
å¯ä»¥çœ‹åˆ°åªè¦æŠŠè¿™ä¸ªwatchå®ä¾‹æ·»åŠ åˆ°data.a.b.cå±æ€§çš„Depä¸­å°±è¡Œï¼Œå½“å±æ€§å€¼æ”¹å˜ï¼Œé€šçŸ¥watcher
```
export default class Watcher {
    constructor (vm, expOrFn, cb) {
        this.vm = vm
        this.getter = parsePath(expOrFn)
        this.cb = cb
        this.value = this.get();
    }

    get () {
        window.target = this
        let value = this.getter.call(this.vm, this.vm) // ä¸ºä»€ä¹ˆæ˜¯ä¸¤ä¸ªthis.vmï¼Œå› ä¸ºè¦è·å–vmä¸Šçš„å‚æ•°ï¼Œå¾—è·å–åˆ°vmçš„ç¯å¢ƒ
        window.target = undefined
        return value
    }

    update () {
        const oldValue = this.value
        this.value = this.get()
        this.cb.call(this.vm, this.value, oldValue)
    }
}
/**
 * è§£æç®€å•è·¯å¾„
 */
const bailRE = /[^\w.$]/
export function parsePath (path) {
    if (bailRE.test(path)) {
        return
    }
    const segments = path.split('.')
    return function (obj) {
        for (let i = 0; i < segments.length; i++) {
            if (!obj) return;
            obj = obj[segments[i]] // a.b.cå°†aï¼Œbï¼Œcéƒ½ä½œä¸ºä¾èµ–æ”¶é›†
        }
        return obj
    }
}
```
åœ¨getæ–¹æ³•ä¸­æŠŠwindow.targetè®¾ç½®æˆthisï¼Œä¹Ÿå°±æ˜¯å½“å‰watcherå®ä¾‹ï¼Œç„¶åè¯»å–data.a.b.cçš„å€¼ï¼Œè§¦å‘getterï¼Œè§¦å‘æ”¶é›†ä¾èµ–çš„é€»è¾‘ï¼Œä¼šä»window.taregtä¸­è¯»å–ä¸€ä¸ªä¾èµ–å¹¶æ·»åŠ åˆ°Depä¸­ï¼Œä¾èµ–æ³¨å…¥åˆ°Depä¸­åï¼Œæ¯å½“data.a.b.cçš„å€¼å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šè®©ä¾èµ–åˆ—è¡¨ä¸­æ‰€æœ‰ä¾èµ–å¾ªç¯è§¦å‘updateæ–¹æ³•

ä¸Šè¿°ä»£ç åªèƒ½ä¾¦æµ‹æ•°æ®ä¸­çš„æŸä¸€ä¸ªå±æ€§ï¼Œæˆ‘ä»¬å¸Œæœ›æŠŠæ•°æ®ä¸­çš„æ‰€æœ‰å±æ€§éƒ½ä¾¦æµ‹åˆ°ï¼Œæ‰€ä»¥è¦å°è£…æˆä¸€ä¸ªObserverç±»ï¼Œå°†ä¸€ä¸ªæ•°æ®å†…çš„æ‰€æœ‰å±æ€§ï¼ˆåŒ…æ‹¬å­å±æ€§ï¼‰éƒ½è½¬æ¢æˆgetter/setterçš„å½¢å¼ï¼Œå»è¿½è¸ªå®ƒä»¬çš„å˜åŒ–ã€‚

## é€’å½’ä¾¦æµ‹æ‰€æœ‰çš„key ##
```
/**
 * Observerç±»ä¼šé™„åŠ åˆ°æ¯ä¸€ä¸ªè¢«ä¾¦æµ‹çš„objectä¸Šï¼Œ
 * ä¸€æ—¦è¢«é™„åŠ ä¸Šï¼ŒObserverä¼šå°†objectçš„æ‰€æœ‰å±æ€§è½¬æ¢æˆgetter/setterçš„å½¢å¼æ¥æ”¶é›†å±æ€§çš„ä¾èµ–
 * å¹¶ä¸”å½“å±æ€§å‘ç”Ÿå˜åŒ–æ—¶ä¼šé€šçŸ¥è¿™äº›ä¾èµ–
 */
export class Observer {
    constructor (value) {
        this.value = value;

        if (!Array.isArray(value)) {
            this.walk(value);
        }
    }
    /**
     * 
     * walkä¼šå°†æ¯ä¸€ä¸ªå±æ€§éƒ½è½¬æ¢æˆgetter/setterçš„å½¢å¼æ¥ä¾¦æµ‹å˜åŒ–
     * è¿™ä¸ªæ–¹æ³•åªæœ‰åœ¨æ•°æ®ç±»å‹ä¸ºobjectæ—¶è¢«è°ƒç”¨
     */
    walk (obj) {
        const keys = Object.keys(obj);
        for (let i = 0; i < keys.length; i++) {
            defineReactive(obj, keys[i], obj[keys[i]]);
        }
    }
}

function defineReactive(data, key, val) {
    if (typeof val === 'object') {
        new Observer(val);
    }
    let dep = new Dep();
    Object.defineProperty(data, key, {
        enumerable: true,
        configurable: true,
        get: function() {
            dep.depend();
            return val;
        },
        set: function(newVal) {
            if(val === newVal) {
                return;
            }
            val = newVal;
            dep.notify();
        }
    })
}
```
## å…³äºObjectçš„é—®é¢˜ ##
å‰é¢ä»‹ç»äº†Objectç±»å‹æ•°æ®å˜åŒ–ä¾¦æµ‹çš„åŸç†ï¼Œäº†è§£äº†æ•°æ®çš„å˜åŒ–æ˜¯é€šè¿‡getter/setteræ¥è¿½è¸ªçš„ï¼Œä½†æœ‰äº›è¯­æ³•å³ä¾¿æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œvue.jsä¹Ÿè¿½è¸ªä¸åˆ°
æ¯”å¦‚æ–°å¢å±æ€§
```
var vm = new Vue({
    el: '#el',
    template: '#demo-template',
    data: {
        obj: {},
    },
    methods: {
        action() {
            this.obj.name = 'brewin';
        }
    }
})
æˆ–è€…åˆ é™¤å±æ€§
var vm = new Vue({
    el: '#el',
    template: '#demo-template',
    data: {
        obj: {
            name: 'brewin',
        },
    },
    methods: {
        action() {
            delete this.obj.name;
        }
    }
})
```
vueé€šè¿‡Object.definePropertyæ¥å°†å¯¹è±¡çš„keyè½¬æ¢æˆgetter/setterçš„å½¢å¼æ¥è¿½è¸ªå˜åŒ–ï¼Œä½†getter/setteråªèƒ½è¿½è¸ªä¸€ä¸ªæ•°æ®æ˜¯å¦è¢«ä¿®æ”¹ï¼Œæ— æ³•è¿½è¸ªæ–°å¢å±æ€§å’Œåˆ é™¤å±æ€§ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæä¾›äº†ä¸¤ä¸ªAPI-vm.$setå’Œvm.$deleteæ–¹æ³•ã€‚

## æ€»ç»“ ##
å˜åŒ–ä¾¦æµ‹å°±æ˜¯ä¾¦æµ‹æ•°æ®çš„å˜åŒ–ï¼Œå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¦èƒ½ä¾¦æµ‹å¹¶å‘å‡ºé€šçŸ¥
1. Objectå¯ä»¥é€šè¿‡Object.definePropertyå°†å±æ€§è½¬æ¢æˆgetter/setterçš„å½¢å¼æ¥è¿½è¸ªå˜åŒ–ï¼Œè¯»å–æ•°æ®è§¦å‘getterï¼Œä¿®æ”¹æ•°æ®è§¦å‘setter
2. åœ¨getterä¸­æ”¶é›†æœ‰é‚£äº›ä¾èµ–ä½¿ç”¨äº†æ•°æ®ï¼Œå½“setterè¢«è§¦å‘æ—¶ï¼Œå»é€šçŸ¥getterä¸­æ”¶é›†çš„ä¾èµ–æ•°æ®å˜åŒ–
3. æ”¶é›†ä¾èµ–éœ€è¦å»ºç«‹ä¸€ä¸ªæ•°ç»„Depæ¥å­˜å‚¨
4. æ‰€è°“çš„ä¾èµ–ï¼Œå°±æ˜¯Watcherï¼Œåªæœ‰Watcherè§¦å‘çš„getteræ‰ä¼šæ”¶é›†ä¾èµ–ï¼Œå“ªä¸ªWatcherè§¦å‘äº†getterï¼Œæ‹¿ä¸ªWatcherå°±è¢«æ”¶é›†åˆ°Depä¸­ï¼Œå½“æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œä¼šå¾ªç¯ä¾èµ–åˆ—è¡¨ï¼ŒæŠŠæ‰€æœ‰çš„Watcheréƒ½é€šçŸ¥ä¸€é
5. Watcherçš„åŸç†æ˜¯å…ˆæŠŠè‡ªå·±è®¾ç½®æˆå…¨å±€å”¯ä¸€çš„æŒ‡å®šä½ç½®ï¼ˆæ¯”å¦‚window.targetï¼‰ï¼Œç„¶åè¯»å–æ•°æ®ï¼Œè§¦å‘getterï¼Œåœ¨getterä¸­å°±ä¼šä»å…¨å±€å”¯ä¸€çš„é‚£ä¸ªä½ç½®è¯»å–å½“å‰æ­£åœ¨è¯»å–æ•°æ®çš„Watcherï¼Œå¹¶æŠŠè¿™ä¸ªWatcheræ”¶é›†åˆ°Depä¸­ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ï¼ŒWatcherå¯ä»¥ä¸»åŠ¨è®¢é˜…ä»»æ„ä¸€ä¸ªæ•°æ®çš„å˜åŒ–
6. ä¸ºäº†ä¾¦æµ‹åˆ°objectä¸­æ‰€æœ‰æ•°æ®çš„å˜åŒ–ï¼Œåˆ›å»ºäº†ObserverğŸ¥±ï¼Œå°†objetcä¸­çš„æ‰€æœ‰æ•°æ®é€’å½’è½¬æ¢æˆå“åº”å¼çš„ã€‚